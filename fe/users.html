<!DOCTYPE html>
<html>

    <head>
        <title>User Management</title>
        <link rel="stylesheet"
            href="https://cdn.datatables.net/1.11.2/css/jquery.dataTables.min.css">
        <link rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link rel="stylesheet" href="style_tasks.css">
    </head> 
<body>
        <div id="app">
            <nav class='navigation'>
                <ul>
                  <li><a href="index.html">Trang chủ</a></li>
                  <li><a href="users.html">Quản lý User</a></li>
                  <li><a href="tasks2.html">Quản lý công việc</a></li>
                  <!-- <li><a href="tasksprogress.html">Theo dõi tiến độ</a></li> -->
                </ul>
              </nav>
            <div class="container mt-4">
                <h1 style="text-align: center">User Management</h1>
                <div class="d-flex justify-content-start mb-3">
                    <button stytype="button" class="btn btn-success"
                        data-bs-toggle="modal" data-bs-target="#addTaskModal">
                        Add Task
                    </button>
                </div>
                <table id="taskTable" class="display">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Address</th>
                            <th>Gender</th>
                            <th>Status</th>
                            <th>Birthday</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Table data will be populated here -->
                    </tbody>
                </table>
            </div>
    
            <!-- Add Task Modal -->
            <div class="modal fade" id="addTaskModal" tabindex="-1" role="dialog"
                aria-labelledby="addTaskModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-name" id="addTaskModalLabel">Add New </h5>
                            <button type="button" class="btn-close"
                                data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addTaskForm">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Name</label>
                                    <input type="text" class="form-control"
                                        id="name" name="name" required placeholder="Name">
                                </div>
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Phone</label>
                                    <input type="phone" class="form-control" id="phone"
                                        name="phone" rows="3" required placeholder="Phone">
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control"
                                        id="email" name="email" required placeholder="Email">
                                </div>
                                <div class="mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <input type="address" class="form-control"
                                        id="address" name="address" required placeholder="Address">
                                </div>
                                <div class="mb-3">
                                    <label for="gender" class="form-label">Gender</label>
                                    <select class="form-select" id="gender"
                                        name="gender" required>
                                        <option value="nam">Nam</option>
                                        <option value="nu">Nữ</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="status" class="form-label">Status</label>
                                    <input type="status" class="form-control"
                                        id="status" name="status" required placeholder="Status">
                                </div>
                                <div class="mb-3">
                                    <label for="birthday" class="form-label">Birthday</label>
                                    <input type="date" class="form-control"
                                        id="birthday" name="birthday" required placeholder="Birthday">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary"
                                data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary"
                                id="btn_save">Save User</button>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Edit Task Modal -->
            <div class="modal fade" id="editTaskModal" tabindex="-1" role="dialog"
                aria-labelledby="editTaskModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-name" id="editTaskModalLabel">Edit
                                User</h5>
                            <button type="button" class="btn-close"
                                data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editTaskForm">
                                <input type="hidden" id="userId" name="userId">
                                <div class="mb-3">
                                    <label for="editName" class="form-label">Name</label>
                                    <input type="text" class="form-control"
                                        id="editName" name="editName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editPhone" class="form-label">Phone</label>
                                    <input type="phone" class="form-control"
                                        id="editPhone" name="editPhone" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control"
                                        id="editEmail" name="editEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editAddress" class="form-label">Address</label>
                                    <input type="address" class="form-control"
                                        id="editAddress" name="editAddress" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editGender" class="form-label">Gender</label>
                                    <div class="gender">
                                        <select class="form-select" id="editGender"
                                            name="editGender" required>
                                            <option value="nam">Nam</option>
                                            <option value="nu">Nữ</option>
                                        </select>
                                    </div>                                  
                                </div>
                                <div class="mb-3">
                                    <label for="editStatus" class="form-label">Status</label>
                                    <input type="status" class="form-control"
                                        id="editStatus" name="editStatus" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editBirthday" class="form-label">Birthday</label>
                                    <input type="date" class="form-control"
                                        id="editBirthday" name="editBirthday" required>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary"
                                    onclick="updateTask()">Save Changes</button>
                            </div>
                        </div>
                    </div>
            </div>
    
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.2/js/jquery.dataTables.min.js"></script>
                

    <script>

        let dataTask=[];
        
        function editTask(id) {
            let item = dataTask.find((item) => item.id == id);
            document.getElementById('userId').value = item.id;
            document.getElementById('editName').value = item.name;
            document.getElementById('editPhone').value = item.phone;
            document.getElementById('editEmail').value = item.email;
            document.getElementById('editAddress').value = item.address;
            document.getElementById('editGender').value = item.gender;
            document.getElementById('editStatus').value = item.status;
            document.getElementById('editBirthday').value = formatDateTime(item.birthday);
            $('#editTaskModal').modal('show');
        }
        function updateTask() {
            let id = document.getElementById('userId').value;
            let item = dataTask.find((item) => item.id == id);
            item.name = document.getElementById('editName').value;
            item.phone = document.getElementById('editPhone').value;
            item.email = document.getElementById('editEmail').value;
            item.address = document.getElementById('editAddress').value;
            item.gender = document.getElementById('editGender').value;
            item.status = document.getElementById('editStatus').value;
            item.birthday = document.getElementById('editBirthday').value;
            $('#editTaskModal').modal('hide');
            renderTable(dataTask);
            fetch('http://localhost:5000/users/editUser/' + id, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(item)
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                    // location.reload();
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }
        function deleteTask(id) {
        if (confirm("Are you sure you want to delete this task?")) {
            // If user confirms, perform the delete action
            fetch(`http://localhost:5000/users/delete/${id}`, {
            method: "DELETE",
            })
            .then((response) => response.json())
            .then((data) => {
                console.log("Deleted task:", data);
                // After successful deletion, reload the table to show updated data
                location.reload();
            })
            .catch((error) => {
                console.error("Error deleting task:", error);
            });
        }
        }

        function renderTable(data) {
            $('#taskTable').DataTable().clear().destroy();
            $('#taskTable').DataTable({
                data: data,
                    columns: [
                        { data: 'id' },
                        { data: 'name' },
                        { data: 'phone' },
                        { data: 'email' },
                        { data: 'address' },
                        { data: 'gender'},
                        { data: 'status' },
                        {   data: 'birthday',
                            render: function (data) {
                                return formatDateTime(data);
                            },
                        },
                        {
                            data: null,
                            render: function (data, type, row) {
                                return `
                                    <button type="button" class="btn btn-primary btn-sm edit-btn" data-bs-toggle="modal" onclick="editTask(${data.id})" data-bs-target="#editTaskModal">
                                        <i style= "color: white;" class="fa fa-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm delete-btn" onclick="deleteTask(${data.id})">
                                        <i style= "color: white;" class="fa fa-trash"></i>
                                    </button>
                                `;
                            },
                        },
                    ],

                });
            }
            
        function formatDateTime(dateTime) {
                const dt = new Date(dateTime);
                // yyyy-mm-dd
                const year = dt.getFullYear();
                const month = (dt.getMonth() + 1).toString().padStart(2, '0');
                const day = dt.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
        }
        function saveTask() {
                const formData = $('#addTaskForm').serializeArray();
                const newTask = {};
                formData.forEach(field => {
                    newTask[field.name] = field.value;
                });
                // You can add code here to send the newTask data to the server using Ajax or other methods.
                // Once the task is saved successfully, you can update the DataTable with the new data.
                fetch("http://localhost:5000/users/createUser",{
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(newTask)
                })
                .then(response => response.json()
                )
                .then(dataFromServer => {
                    console.log(dataFromServer);
                    // location.reload();
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                    });
                
                 // Close the modal after saving the task.
            }
        
        $(document).ready(function () {

            $("#btn_save").click(function(){
                saveTask();
            });
            // Fetch users and render options when the document is ready
            // Fetch tasks and render the DataTable when the document is ready
            fetch('http://localhost:5000/users')
                .then(response => response.json())
                .then(data => {
                    dataTask = data;
                    renderTable(dataTask);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        });
    </script>
        </body>

    </html>
